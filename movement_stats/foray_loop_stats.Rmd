---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(lubridate)
library(here)
library(amt)
library(sf)
```

```{r}
integrated_results <- readRDS(here("classifier_integrated", "fac_primary_state_delineation.rds")) %>% 
  arrange(animal_name, time)

#make a column that has the prior steps for each location
integrated_results <- integrated_results %>% 
  group_by(animal_name) %>% 
  group_modify(.f = function(x, y){
    if(nrow(x) == 1){
      x$prior_step <- NA
    } else {
      x$prior_step <- c(NA, x$primary_step_state[1:(nrow(x)-1)])
    }
    return(x)
  }) %>% 
  ungroup() %>% 
  mutate(date = as_date(time)) %>% 
  mutate(date_standardized = ymd(paste0("2020-", month(date), "-", day(date))))
```

Did a bird keep transmitting for at least a month? If so, did it make a foray loop movement?
Should be 13 of these
```{r}
foray_frequency <- integrated_results %>% 
  group_by(animal_name) %>%
  group_map(.f = function(x, y){
    ml <- max(x$time) - min(x$time)
    ml <- ml %>% 
      as.numeric
    if (ml >= 30){
      forayed <- "Foray loop" %in% x$primary_step_state
      
      tibble(animal_name = y$animal_name,
             over_30 = TRUE,
             forayed = forayed) %>% 
        return()
      
    } else {
      tibble(animal_name = y$animal_name,
             over_30 = FALSE,
             forayed = NA) %>% 
        return()
    }
  }) %>% 
  bind_rows() %>% 
  filter(over_30)

sum(foray_frequency$forayed) #16
nrow(foray_frequency) #456
sum(foray_frequency$forayed)/nrow(foray_frequency) #3%
```

Measure dispersal length
```{r}
foray_tracks <- integrated_results %>% 
  filter(primary_step_state == "Foray loop" | (primary_point_state == "Stationary" & prior_step == "Foray loop")) %>% 
  group_by(animal_name) %>% 
  nest() %>% 
  mutate(track = map(data, .f = function(i){
    i <- i %>% 
      st_as_sf(crs = 4326, coords = c("long", "lat")) %>% 
      st_transform(5070)
    
    cbind(st_drop_geometry(i), st_coordinates(i)) %>%
      make_track(.x = X, .y = Y, .t = time, crs = 5070)
    
  })) %>% 
  mutate(step_lengths = map(track, .f = function(x){
    x %>%
      step_lengths()
  })) %>% 
  mutate(mig_dist = map(step_lengths, .f = function(x){
    x %>% 
      sum(., na.rm = TRUE)/1000
  })
  ) %>% 
  mutate(mig_length = map(data, function(x){
    ml <- max(x$time) - min(x$time)
    ml %>% 
      round() %>% 
      return()
  }))

#distance of foray loops (km)
foray_tracks$mig_dist %>% 
  as.numeric() %>% 
  mean()

foray_tracks$mig_dist %>% 
  as.numeric() %>% 
  range()

#length of foray loops (days)
foray_tracks$mig_length %>% 
  as.numeric() %>% 
  mean()

foray_tracks$mig_length %>% 
  as.numeric() %>% 
  range()
```